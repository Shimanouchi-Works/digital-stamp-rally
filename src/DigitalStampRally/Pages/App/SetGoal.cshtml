@page
@using System.Text.Json
@model DigitalStampRally.Pages.SetGoalModel
@{
    ViewData["Title"] = "ã‚´ãƒ¼ãƒ«ç¢ºèª";
}

<div class="container py-4">
    <div class="mb-3">
        <h1 class="h4 fw-bold mb-1">@Model.EventTitle</h1>
        @* <div class="text-muted small">
            æœ‰åŠ¹æœŸé™ï¼š@Model.ValidFrom:yyyy/MM/dd HH:mm ï½ @Model.ValidTo:yyyy/MM/dd HH:mm
        </div> *@
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">@Model.ErrorMessage</div>
        <a class="btn btn-outline-secondary" href="/App/Index">ãƒ›ãƒ¼ãƒ ã¸</a>
        return;
    }

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <div class="text-muted small">ã‚´ãƒ¼ãƒ«ç¢ºèª</div>
                    <div class="h5 fw-bold mb-0">ã“ã®ç«¯æœ«ã®åé›†çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã‚´ãƒ¼ãƒ«ã—ã¾ã™</div>
                </div>
                @* <span id="badge-goaled" class="badge text-bg-success d-none">ã‚´ãƒ¼ãƒ«æ¸ˆã¿</span> *@
                <div id="goal-state"
                    class="alert alert-warning d-flex align-items-center justify-content-between flex-wrap gap-2 mb-0"
                    role="alert">
                    <div class="fw-bold">
                        çŠ¶æ…‹ï¼š<span id="goal-state-text">ã‚´ãƒ¼ãƒ«å‰ã§ã™</span>
                    </div>
                    @* <div class="small">
                        â€» ä¸»å‚¬è€…ã®ç¢ºèªã®ã‚‚ã¨ã€å‚åŠ è€…ã«æ“ä½œã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„
                    </div> *@
                </div>
                <div id="goal-clear-banner" 
                    class="alert alert-success text-center fw-bold display-6 d-none mt-3">
                    ğŸ‰ ã‚¯ãƒªã‚¢ï¼
                </div>
            </div>



            <hr class="my-3" />



            <div class="d-flex align-items-center gap-3 flex-wrap">
                <button id="btn-goal" class="btn btn-primary" type="button">
                    ã‚´ãƒ¼ãƒ«ã™ã‚‹
                </button>

                <div class="text-danger small fw-semibold">
                    â€» ä¸»å‚¬è€…ç¢ºèªã®ã‚‚ã¨ã€ã‚´ãƒ¼ãƒ«ã—ã¦ãã ã•ã„
                </div>
            </div>

            <div id="goal-message" class="small text-muted mt-2"></div>

            <div class="small text-muted mt-3">
                @* æ³¨æ„ï¼š
                <br />ãƒ»ã‚´ãƒ¼ãƒ«ã™ã‚‹ã¨ä»¥å¾Œã‚¹ã‚¿ãƒ³ãƒ—èª­ã¿å–ã‚Šã¯ã§ãã¾ã›ã‚“
                <br />ãƒ»åŒã˜ç«¯æœ«ï¼ˆåŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã§é›†ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ *@
                æ³¨æ„ï¼šã‚´ãƒ¼ãƒ«ã™ã‚‹ã¨ä»¥å¾Œã‚¹ã‚¿ãƒ³ãƒ—èª­ã¿å–ã‚Šã¯ã§ãã¾ã›ã‚“ã€‚
            </div>


            <hr class="my-3" />



            <div class="mt-3">
                @if( Model.RequiredSpotIds.Count > 0 )
                {
                    <div class="small text-muted">å¿…é ˆã‚¹ã‚¿ãƒ³ãƒ—</div>
                    <div class="fw-bold">
                        <span id="required-count">0</span> / <span id="required-total">@Model.RequiredSpotIds.Count</span>
                    </div>
                    <div id="required-hint" class="small text-muted mt-1"></div>
                }
            </div>

            <div class="mb-2 small text-muted">åé›†ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—</div>
            <ul class="list-group" id="stamp-list"></ul>


        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h6 fw-bold mb-2">é”æˆã‚³ãƒ¼ãƒ‰</h2>
            <div class="display-6 fw-bold" id="achievement-code">----</div>
            <div class="small text-muted" id="achievement-hint">ã‚´ãƒ¼ãƒ«å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
    </div>

    @* <div class="mt-3">
        <a class="btn btn-outline-secondary" href="/App/Index">ãƒ›ãƒ¼ãƒ ã¸</a>
    </div> *@
    <div class="mt-3 d-flex flex-column gap-2">
        <button class="btn btn-outline-secondary" onclick="window.close();">
            ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹
        </button>
        <div class="small text-muted text-center">
            â€» ã“ã®ãƒœã‚¿ãƒ³ã§é–‰ã˜ãªã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€ŒÃ—ã€ã§ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„
        </div>
    </div>
</div>
<div id="globalLoading" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white"
     style="z-index:1050;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
        <div class="mt-3">å‡¦ç†ä¸­ã§ã™â€¦</div>
    </div>
</div>

@section Scripts {
<script>
(function(){
    const eventId = @Html.Raw(JsonSerializer.Serialize(Model.EventId));
    const token = @Html.Raw(JsonSerializer.Serialize(Model.Token));
    const spotMap = @Html.Raw(JsonSerializer.Serialize(Model.SpotMap)); // {"123":{name,isRequired}}
    const requiredSpotIds = @Html.Raw(JsonSerializer.Serialize(Model.RequiredSpotIds)); // number[]

    const stateText = document.getElementById("goal-state-text");
    const stateWrap = document.getElementById("goal-state");

    const loader = document.getElementById("globalLoading");

    const KEY_VISITOR = "dsr:visitorId";
    const KEY_STAMPS = `dsr:stamps:${eventId}`; // { "123": "iso", ... }

    function uuidv4() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === "x" ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getVisitorId(){
        try{
            let v = localStorage.getItem(KEY_VISITOR);
            if(!v){
                v = uuidv4();
                localStorage.setItem(KEY_VISITOR, v);
            }
            return v;
        } catch (e) {
            return uuidv4();
        }
    }

    function loadStamps(){
        try{
            const raw = localStorage.getItem(KEY_STAMPS);
            if(!raw) return {};
            const obj = JSON.parse(raw);
            return (obj && typeof obj === "object") ? obj : {};
        }catch{
            return {};
        }
    }

    function isRequired(spotId){
        return requiredSpotIds.includes(Number(spotId));
    }

    function countRequiredCollected(stamps){
        let c = 0;
        for(const rid of requiredSpotIds){
            if(stamps[String(rid)]) c++;
        }
        return c;
    }

    function sortEntriesByTime(stamps){
        return Object.entries(stamps)
            .map(([sid, ts]) => ({ sid, ts }))
            .sort((a,b) => (a.ts > b.ts ? -1 : a.ts < b.ts ? 1 : 0));
    }

    function renderStampList(stamps){
        const ul = document.getElementById("stamp-list");
        ul.innerHTML = "";

        const entries = sortEntriesByTime(stamps);
        if(entries.length === 0){
            const li = document.createElement("li");
            li.className = "list-group-item text-muted";
            li.textContent = "ã¾ã ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
            ul.appendChild(li);
            return;
        }

        for(const e of entries){
            const meta = spotMap[e.sid];
            const name = meta ? meta.Name : e.sid;

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            const left = document.createElement("div");
            @* left.innerHTML = `<div class="fw-bold">${name}</div><div class="small text-muted">${e.ts}</div>`; *@
            left.innerHTML = `<div class="fw-bold">${name}</div>
                            <div class="small text-muted">${formatJst(e.ts)}</div>`;

            const badge = document.createElement("span");
            badge.className = (isRequired(e.sid) ? "badge-primary" : "badge-secondary");
            badge.textContent = isRequired(e.sid) ? "å¿…é ˆ" : "ä»»æ„";

            li.appendChild(left);
            li.appendChild(badge);
            ul.appendChild(li);
        }
    }

    async function postJson(url, body){
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        return res;
    }

    const visitorId = getVisitorId();
    const stamps = loadStamps();

    renderStampList(stamps);

    const reqCollected = countRequiredCollected(stamps);
    let requiredCount = document.getElementById("required-count");
    if( requiredCount ){
        requiredCount.textContent = String(reqCollected);
    }


    const hint = document.getElementById("required-hint");
    if( hint ){
        if(requiredSpotIds.length === 0){
            hint.textContent = "å¿…é ˆã‚¹ã‚¿ãƒ³ãƒ—ã®æŒ‡å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        }else if(reqCollected < requiredSpotIds.length){
            hint.textContent = "å¿…é ˆã‚¹ã‚¿ãƒ³ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚";
        }else{
            hint.textContent = "å¿…é ˆã‚¹ã‚¿ãƒ³ãƒ—ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚";
        }
    }

    const btn = document.getElementById("btn-goal");
    const msg = document.getElementById("goal-message");
    @* const badgeGoaled = document.getElementById("badge-goaled"); *@
    const codeEl = document.getElementById("achievement-code");
    const codeHint = document.getElementById("achievement-hint");

    // ã‚´ãƒ¼ãƒ«æ¸ˆã¿ç¢ºèª
    (async () => {
        try{
            const baseUrl = '@Url.Page("/App/SetGoal", null, new { handler = "Status" })';
            const url = new URL(baseUrl, window.location.origin);
            const res = await postJson(url, { eventId, token, visitorId });
            if(!res.ok) return;
            const data = await res.json();
            if(data.success && data.goaled){
                @* if (badgeGoaled) {
                    badgeGoaled.classList.remove("d-none");
                } *@
                btn.disabled = true;
                msg.textContent = "ã“ã®ç«¯æœ«ã¯ã™ã§ã«ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã§ã™ã€‚";

                // â˜…è¿½åŠ ï¼šçŠ¶æ…‹æ–‡è¨€ã‚’æ›´æ–°
                if (stateText) stateText.textContent = "ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã§ã™";
                if (stateWrap) {
                    stateWrap.classList.remove("alert-warning");
                    stateWrap.classList.add("alert-success");
                }

                if(data.code){
                    codeEl.textContent = formatAchievementCode(data.code);
                    codeHint.textContent = "ä¸»å‚¬è€…ã®é›†è¨ˆç”»é¢ã§ç…§ä¼šã§ãã¾ã™ã€‚";
                }
            }
        }finally{
            loader.remove(); // å®Œå…¨ã«å‰Šé™¤
        }
    })();

    btn.addEventListener("click", async () => {
        btn.disabled = true;
        msg.textContent = "ã‚´ãƒ¼ãƒ«å‡¦ç†ä¸­â€¦";

        const baseUrl = '@Url.Page("/App/SetGoal", null, new { handler = "Goal" })';
        const url = new URL(baseUrl, window.location.origin);
        const res = await postJson(url, { eventId, token, visitorId });

        if(!res.ok){
            btn.disabled = false;
            msg.textContent = "ã‚´ãƒ¼ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
            return;
        }

        const data = await res.json();
        if(!data.success){
            btn.disabled = false;
            msg.textContent = data.message || "ã‚´ãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            return;
        }

        @* badgeGoaled.classList.remove("d-none"); *@
        msg.textContent = "ã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚ä»¥å¾Œã‚¹ã‚¿ãƒ³ãƒ—èª­ã¿å–ã‚Šã¯ã§ãã¾ã›ã‚“ã€‚";
        const banner = document.getElementById("goal-clear-banner");
        if (banner) {
            banner.classList.remove("d-none");
        }

        sendEvent( 'goal_complete', {
            event_id: '@Model.EventId'
        });

        // â˜…è¿½åŠ ï¼šçŠ¶æ…‹æ–‡è¨€ã‚’æ›´æ–°
        if (stateText) stateText.textContent = "ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã§ã™";
        if (stateWrap) {
            stateWrap.classList.remove("alert-warning");
            stateWrap.classList.add("alert-success");
        }

        if(data.code){
            codeEl.textContent = formatAchievementCode(data.code);
            codeHint.textContent = "ä¸»å‚¬è€…ã®é›†è¨ˆç”»é¢ã§ç…§ä¼šã§ãã¾ã™ã€‚";
        }
    });
})();
</script>
}
